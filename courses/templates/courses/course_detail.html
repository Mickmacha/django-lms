{% extends 'courses/course_base.html' %} 
{% load bootstrap4 %}
{% load courses_extras %}
{% load static %}
{% block title_name %}
  LMS - {{course.course_name}}
{% endblock title_name %}

{% block main_content %}
<h1 class="font-sans font-semibold text-3xl m-2">{{course.course_name}}</h1>
{% if user.user_type == 1 %}
<!-- Progress Bar -->
<div class="progress">
  <div class="progress-bar" role="progressbar" style="width: {{ completion_percentage }}%;" aria-valuenow="{{ completion_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
</div>
{% endif %}

{% if completion_percentage >= 100 %}
<p class="font-sans text-xl m-2 text-green-600">Course Completed!</p>
{% endif %}

<!-- Display the total number of lessons -->
<p class="font-sans text-xl m-2">Total Lessons: <span class="font-semibold">{{ total_lessons }}</span></p>
<!-- Display the total number of completed lessons for the user -->
<p class="font-sans text-xl m-2">Completed Lessons: <span class="font-semibold">{{ completed_lessons }}</span></p>

<p class="font-sans text-xl m-2">Total Quizzes in Course: <span class="font-semibold">{{ course.total_quizzes }}</span></p>
<p class="font-sans text-xl m-2">Completed Quizzes: <span class="font-semibold">{{ completed_quizzes }}<span></p>
<h4 class="text-xl m-2">Teacher: <span class="font-semibold">{{course.teacher}}</span></h4>
<p class="text-xl m-2">Description: <span class="font-semibold">{{course.course_description}}</span></p>


{% if user.is_authenticated %}
{% for chapter, content in chapters_with_lessons_and_quizzes.items %}
<div class="bg-gray-100 p-4 m-2 rounded-lg">
    <button class="text-xl font-sans font-bold hover:text-blue-600 focus:outline-none" onclick="toggleChapter('{{ chapter.id }}')">
        {{ chapter.chapter_name }}
    </button>
    {% if content.quizzes %}
    <a href="{% url 'assignments:submit_quiz' quiz_id=content.quizzes.0.id %}" class="text-blue-600 hover:underline">Take Quiz</a>
    {% else %}
    <p class="text-red-600">No Quiz</p>
    {% endif %}
    
    <div id="{{ chapter.id }}" class="mt-2 hidden">
        {% for lesson in content.lessons %}
        
        {% if lesson.video %}
        <p class="text-gray-700">Watch this</p>
        <div class="mt-2">
            <div class="lesson-video-container">
            <div id="text-gray-700"> {{ lesson.video }}</div>
            <div id="player{{ lesson.id }}"></div>
            </div>
            
            
        </div>
        {% endif %}

        <div class="bg-white p-3 m-2 rounded-lg shadow-md mb-2">
            <p class="text-xl font-sans font-semibold underline">{{ lesson.lesson_name }}</p>
            <div class="mt-2 text-gray-700">
                {{ lesson.lesson_content|convert_markdown|safe }}
                {% if user.user_type == 1 %}
        <button class="mark-lesson-button bg-blue-600 text-white font-sans text-md font-bold p-2 m-2 rounded-md hover:cursor-pointer"
            data-lesson-id="{{ lesson.id }}">Mark as Read</button>
                {% endif %}
                <input type="hidden" id="lessonIdField" name="lesson_id" value="{{ lesson.id }}">
                {% csrf_token %}

            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}
{% else %}
    <p class="text-danger font-weight-bold m-2">Please login to view more information.</p>
{% endif %}


{% if user.user_type == 1 %} {%if user in course.students.all%}
<a
  href="{% url 'courses:unenroll' pk=course.pk %}"
  class="bg-red-600 m-2 text-white hover:bg-red-800 p-2 rounded-md text-md font-extrabold hover:no-underline"
  >Unenroll</a
>
{% else %}
<a href="{% url 'courses:enroll' pk=course.pk %}" class="bg-green-600 m-2 text-white hover:bg-green-800 p-2 rounded-md text-md font-extrabold hover:no-underline"
  >Enroll</a
>
{% endif %} 
{% endif %}

{% if course.teacher.id == user.id or user in course.students.all%}
  {% if user.user_type == 2 %}
    
    <a
      href="{% url 'assignments:create' %}"
      class="bg-yellow-500 rounded-md font-semibold text-black hover:text-white hover:bg-black p-2 m-2 shadow-lg text-2xl"
    >
      <i class="fa fa-plus-circle" aria-hidden="true"> Create New Assignment</i>
    </a>
    <a
      href="{% url 'resources:create' %}"
      class="bg-blue-900 rounded-md font-semibold text-white hover:text-black hover:shadow-xl hover:bg-gray-400 p-2 m-2 shadow-lg text-2xl"
    >
      <i class="fa fa-plus-circle" aria-hidden="true"> Create New Resource</i>
    </a>
  {% endif %}
    
  <div class="assignments">
    <h3 class="font-sans font-semibold text-3xl">Assignments</h3>
    <ul class="list-group" class="bg-slate-300">
      {% for assignment in assignments %}
      <a href="{% url 'assignments:detail' pk=assignment.pk %}" class="list-group-item list-group-item-action ">
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1 font-semibold font-serif">{{assignment.assignment_name}}</h5>
        </div>
        <p class="mb-1 font-semibold">
          {{assignment.assignment_description}}
        </p>
        <small>Start Date: {{assignment.start_date}}</small><br>
        <small>Due Date: {{assignment.due_date}} {{assignment.due_time}}</small>
      </a>
      {% empty %}
      <h6>No Assignments</h6>
      {% endfor %}
    </ul>
  </div>
  <div class="resources">
    <h3 class="font-sans font-2xl font-semibold m-2">Resources</h3>

    <!-- {% include 'assignments/assignment_list.html' %} -->
    <ul class="list-group">
      {% for resource in resources %}
      <div  class="list-group-item list-group-item-action">
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1">{{resource.resource_name}}</h5>
        </div>
        <p class="mb-1">
          Submission: {{resource.resource_file.name}}
          <a href="{{resource.resource_file.url}}" class="bg-green-600 m-2 text-white hover:bg-green-800 p-2 rounded-md text-md font-extrabold hover:no-underline" download>Download</a>
        </p>
        
        {% if user.id == course.teacher.id %}
          <small><a href="{% url 'resources:delete' pk=resource.pk %}" class="bg-red-600 m-2 text-white hover:bg-red-800 p-2 rounded-md text-md font-extrabold hover:no-underline">Delete</a></small>
        {% endif %}
      </div>
      {% empty %}
        <h6 class="font-extralight font-serif text-gray-400">No Resources</h6>

      {% endfor %}
    </ul>
  </div>
{% endif %}

<div id="congratulationsPopup" class="flex fixed inset-0 items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-4 max-w-md">
      <span class="float-right cursor-pointer" id="closePopup" style="cursor: pointer;">&times;</span>
      <p class="text-xl font-bold">Congratulations!</p>
      <p class="text-lg">You have completed the course.</p>
  </div>
</div>



<script>
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  function toggleChapter(id) {
      const chapter = document.getElementById(id);
      chapter.classList.toggle('hidden');
  }
     // Initialize the progress based on the number of lessons
     const totalLessons = {{ total_lessons }};
     console.log("Total Lessons:", total_lessons)
     const progressBar = document.getElementById('progressBar');
     const lessonRadioButtons = document.querySelectorAll('.lessonRadio');
  
 function updatechecked(){
   
   // Fetch the completed lessons count via AJAX
   const courseId = parseInt('{{ course.pk }}');
 console.log('Course ID:', courseId);
 fetch("{% url 'courses:completed_lesson_count' course.pk %}", {
   method: "GET",
   headers: {
     "Content-Type": "application/json",
     "X-CSRFToken": getCookie("csrftoken"),
   },
 })
   .then(response => {
     if (!response.ok) {
       throw new Error(`Network response was not ok, status: ${response.status}`);
     }
     return response.json();
   })
   .then(data => {
    if (data.completed_lessons_count !== undefined) {
      const completedLessons = data.completed_lessons_count;
      updateProgress(completedLessons);
      console.log("JSON Response:", data);
    }
   })
   .catch(error => {
     console.error('Fetch error:', error);
   });
 
 function updateProgress(completedLessons) {
     const progressBar = document.getElementById('progressBar');
     const lessonRadioButtons = document.querySelectorAll('.lessonRadio');
     const totalLessons = {{ total_lessons }};
 
   // Update the checked state of checkboxes for completed lessons
     completedLessons.forEach(lessonId => {
       const lessonCheckbox = document.querySelector(`#lessonRadio${lessonId}`);
       if (lessonCheckbox) {
         lessonCheckbox.checked = true;
         lessonCheckbox.disabled = true;
 
         // Disable the corresponding "Mark as Read" button
         const lessonButton = document.querySelector(`#markAsReadButton_${lessonId}`);
         if (lessonButton) {
           lessonButton.disabled = true;
         }
       }
   });
 }
 }
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const markLessonButtons = document.querySelectorAll('.mark-lesson-button');

    markLessonButtons.forEach((markLessonButton) => {
        markLessonButton.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent the default button click behavior

            // Check if the button is disabled (already clicked)
            if (markLessonButton.disabled) {
                return; // Don't process if already disabled
            }

            const lessonId = markLessonButton.getAttribute('data-lesson-id');
            const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

            // Send an AJAX request to mark the lesson as complete
            fetch('{% url 'courses:mark_lesson_as_complete' %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', // Change content type to JSON
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ lesson_id: lessonId }), // Convert to JSON format
            })
            .then((response) => response.json())
            .then((data) => {
                console.log(data.message); // Log the response message
                // Disable the button after marking as complete
                markLessonButton.disabled = true;
                window.location.reload();
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        });
    });
});





</script>

<script>
    // Define lessonData as a JavaScript variable and populate it with data from Django template
    var lessonData = [
        {% for chapter, content in chapters_with_lessons_and_quizzes.items %}
        {% for lesson in content.lessons %}
        {
            id: '{{ lesson.id }}',
            height: '360', // Set the desired video height
            width: '640',  // Set the desired video width
            videoId: '{{ lesson.video.video_lesson_id }}', // Replace with the actual video ID for the lesson
        },
        {% endfor %}
        {% endfor %}
    ];
    
</script>

<script>
  // Check the completion percentage
  var completionPercentage = {{ completion_percentage }};
  console.log("Completion Percentage:", completionPercentage);
  
  // Show the congratulations popup if completion percentage is 100
  if (completionPercentage === 100) {
      var popup = document.getElementById("congratulationsPopup");
      popup.classList.remove("hidden");

      // Close the popup when the close button is clicked
      var closePopup = document.getElementById("closePopup");
      closePopup.onclick = function () {
          popup.classList.add("hidden");
      };

      // Close the popup when the user clicks outside of it
      window.onclick = function (event) {
          if (event.target === popup) {
              popup.classList.add("hidden");
          }
      }; 
  }
</script>

<!-- Include your JavaScript file that uses lessonData -->
<script src="{% static 'js/player.js' %}"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
function onYouTubeIframeAPIReady() {
        initializeYouTubePlayers();
    }
</script>
  
{% endblock main_content %}
